routes:
  - uri: /api/*
    upstream:
      nodes:
        "127.0.0.1:14202": 1
      type: roundrobin
    # vars: [["http_api_server", "IN", ["node"]]]
    plugins:
      cors: {}
      openid-connect:
        # https://github.com/apache/apisix/issues/5425
        client_id: none
        client_secret: none
        discovery: https://logto.pocki.cc/oidc/.well-known/openid-configuration
        use_jwks: true
        bearer_only: true
        access_token_in_authorization_header: true
        set_userinfo_header: true
      traffic-split:
        rules:
          - match:
              - vars: [["http_api_server", "==", "py"]]
            weighted_upstreams:
              - upstream:
                  name: py
                  nodes:
                    "127.0.0.1:14203": 1
                  type: roundrobin

  - uri: /api
    upstream:
      nodes:
        "127.0.0.1:14202": 1
      type: roundrobin
    plugins:
      cors: {}
#END
